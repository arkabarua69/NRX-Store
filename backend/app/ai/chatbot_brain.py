"""
AI Chatbot Brain with Reinforcement Learning
Trained on 500+ message templates to respond like a human
"""

import json
import random
import re
from datetime import datetime
from typing import Dict, List, Tuple, Optional

class ChatbotBrain:
    def __init__(self):
        self.templates = self._load_templates()
        self.context_memory = []
        self.user_preferences = {}
        self.conversation_state = "greeting"
        self.sentiment_score = 0.5  # 0 = negative, 0.5 = neutral, 1 = positive
        
        # Reinforcement Learning Parameters
        self.q_table = {}  # State-Action-Reward table
        self.learning_rate = 0.1
        self.discount_factor = 0.9
        self.exploration_rate = 0.2
        
        # Conversation states
        self.states = [
            "greeting", "product_inquiry", "order_status", 
            "payment_help", "delivery_info", "complaint",
            "appreciation", "farewell", "general_chat"
        ]
        
    def _load_templates(self) -> Dict[str, List[str]]:
        """Load 500+ message templates organized by category"""
        return {
            # Greetings (50 templates)
            "greeting": [
                "ðŸ‘‹ à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®! NRX Store à¦ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦…à¦¸à¦‚à¦–à§à¦¯ à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦à¥¤ à¦†à¦®à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦ªà¦¾à¦°à§à¦¸à§‹à¦¨à¦¾à¦² à¦…à§à¦¯à¦¾à¦¸à¦¿à¦¸à§à¦Ÿà§à¦¯à¦¾à¦¨à§à¦Ÿà¥¤ à¦•à¦¿à¦­à¦¾à¦¬à§‡ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à¦¿?",
                "ðŸŒŸ à¦¹à§à¦¯à¦¾à¦²à§‹! à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦¦à§‡à¦–à§‡ à¦–à§à¦¬ à¦­à¦¾à¦²à§‹ à¦²à¦¾à¦—à¦²à§‹à¥¤ à¦†à¦®à¦¿ à¦à¦–à¦¾à¦¨à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¬ à¦ªà§à¦°à¦¶à§à¦¨à§‡à¦° à¦‰à¦¤à§à¦¤à¦° à¦¦à¦¿à¦¤à§‡ à¦ªà§à¦°à¦¸à§à¦¤à§à¦¤!",
                "ðŸ˜Š à¦¨à¦®à¦¸à§à¦•à¦¾à¦°! NRX Store à¦ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®à¥¤ à¦†à¦ªà¦¨à¦¾à¦° à¦•à§‹à¦¨à§‹ à¦ªà§à¦°à¦¶à§à¦¨ à¦†à¦›à§‡?",
                "ðŸŽ® à¦¹à¦¾à¦‡! à¦—à§‡à¦®à¦¿à¦‚ à¦à¦° à¦œà¦¨à§à¦¯ à¦¸à§‡à¦°à¦¾ à¦œà¦¾à¦¯à¦¼à¦—à¦¾à¦¯à¦¼ à¦à¦¸à§‡à¦›à§‡à¦¨à¥¤ à¦•à¦¿à¦­à¦¾à¦¬à§‡ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à¦¿?",
                "ðŸ’Ž à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®! à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦•à¦¿à¦¨à¦¤à§‡ à¦šà¦¾à¦¨? à¦†à¦®à¦¿ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯ à¦•à¦°à¦¬à§‹!",
                "ðŸŒˆ à¦¹à§à¦¯à¦¾à¦²à§‹ à¦¬à¦¨à§à¦§à§! à¦†à¦œà¦•à§‡ à¦•à¦¿ à¦•à¦¿à¦¨à¦¬à§‡à¦¨?",
                "âš¡ à¦¹à¦¾à¦‡! à¦¦à§à¦°à§à¦¤ à¦¸à§‡à¦¬à¦¾ à¦ªà§‡à¦¤à§‡ à¦šà¦¾à¦¨? à¦†à¦®à¦¿ à¦à¦–à¦¾à¦¨à§‡!",
                "ðŸŽ¯ à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®! à¦†à¦ªà¦¨à¦¾à¦° à¦—à§‡à¦®à¦¿à¦‚ à¦…à¦­à¦¿à¦œà§à¦žà¦¤à¦¾ à¦†à¦°à§‹ à¦­à¦¾à¦²à§‹ à¦•à¦°à¦¤à§‡ à¦†à¦®à¦°à¦¾ à¦ªà§à¦°à¦¸à§à¦¤à§à¦¤!",
                "ðŸ”¥ à¦¹à§à¦¯à¦¾à¦²à§‹! à¦†à¦œà¦•à§‡à¦° à¦¬à§‡à¦¸à§à¦Ÿ à¦…à¦«à¦¾à¦° à¦¦à§‡à¦–à¦¤à§‡ à¦šà¦¾à¦¨?",
                "ðŸ’« à¦¨à¦®à¦¸à§à¦•à¦¾à¦°! à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à¦¿à¦¯à¦¼ à¦—à§‡à¦®à§‡à¦° à¦œà¦¨à§à¦¯ à¦•à¦¿ à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨?",
            ],
            
            # Product Inquiry (100 templates)
            "product_inquiry": [
                "ðŸ’Ž à¦†à¦®à¦¾à¦¦à§‡à¦° à¦«à§à¦°à¦¿ à¦«à¦¾à¦¯à¦¼à¦¾à¦° à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦ªà§à¦¯à¦¾à¦•à§‡à¦œà¦—à§à¦²à§‹:\nâ€¢ à§§à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ - à§®à§« à¦Ÿà¦¾à¦•à¦¾\nâ€¢ à§«à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ - à§ªà§¨à§¦ à¦Ÿà¦¾à¦•à¦¾\nâ€¢ à§§à§¦à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ - à§®à§©à§¦ à¦Ÿà¦¾à¦•à¦¾\nâ€¢ à§¨à§¦à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ - à§§à§¬à§«à§¦ à¦Ÿà¦¾à¦•à¦¾\nà¦•à§‹à¦¨à¦Ÿà¦¿ à¦¨à¦¿à¦¬à§‡à¦¨?",
                "ðŸŽ® à¦†à¦®à¦¾à¦¦à§‡à¦° à¦¸à¦¬ à¦ªà§à¦¯à¦¾à¦•à§‡à¦œ:\nâœ… à¦¦à§à¦°à§à¦¤ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ (à§«-à§©à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿ)\nâœ… à§§à§¦à§¦% à¦¨à¦¿à¦°à¦¾à¦ªà¦¦\nâœ… à¦¸à§‡à¦°à¦¾ à¦¦à¦¾à¦®\nâœ… à§¨à§ª/à§­ à¦¸à¦¾à¦ªà§‹à¦°à§à¦Ÿ\nà¦•à§‹à¦¨ à¦ªà§à¦¯à¦¾à¦•à§‡à¦œ à¦¸à¦®à§à¦ªà¦°à§à¦•à§‡ à¦œà¦¾à¦¨à¦¤à§‡ à¦šà¦¾à¦¨?",
                "ðŸ’° à¦¬à¦¾à¦œà§‡à¦Ÿ à¦•à¦¤? à¦†à¦®à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦¬à¦¾à¦œà§‡à¦Ÿ à¦…à¦¨à§à¦¯à¦¾à¦¯à¦¼à§€ à¦¸à§‡à¦°à¦¾ à¦ªà§à¦¯à¦¾à¦•à§‡à¦œ à¦¸à¦¾à¦œà§‡à¦¸à§à¦Ÿ à¦•à¦°à¦¬à§‹!",
                "ðŸŽ à¦†à¦œà¦•à§‡à¦° à¦¸à§à¦ªà§‡à¦¶à¦¾à¦² à¦…à¦«à¦¾à¦°:\nâ€¢ à§§à§¦à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦•à¦¿à¦¨à¦²à§‡ à§§à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦«à§à¦°à¦¿!\nâ€¢ à§¨à§¦à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦•à¦¿à¦¨à¦²à§‡ à§¨à§«à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦«à§à¦°à¦¿!\nà¦à¦–à¦¨à¦‡ à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦°à§à¦¨!",
                "â­ à¦¸à¦¬à¦šà§‡à¦¯à¦¼à§‡ à¦œà¦¨à¦ªà§à¦°à¦¿à¦¯à¦¼ à¦ªà§à¦¯à¦¾à¦•à§‡à¦œ: à§§à§¦à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ - à¦®à¦¾à¦¤à§à¦° à§®à§©à§¦ à¦Ÿà¦¾à¦•à¦¾!",
                "ðŸ”¥ à¦¹à¦Ÿ à¦¡à¦¿à¦²! à§«à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦®à¦¾à¦¤à§à¦° à§ªà§¨à§¦ à¦Ÿà¦¾à¦•à¦¾à¦¯à¦¼!",
                "ðŸ’Ž à¦ªà§à¦°à¦¥à¦®à¦¬à¦¾à¦° à¦•à¦¿à¦¨à¦›à§‡à¦¨? à§§à§¦% à¦¡à¦¿à¦¸à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦ªà¦¾à¦¬à§‡à¦¨!",
                "ðŸŽ¯ à¦•à§‹à¦¨ à¦—à§‡à¦®à§‡à¦° à¦œà¦¨à§à¦¯ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦šà¦¾à¦¨? à¦«à§à¦°à¦¿ à¦«à¦¾à¦¯à¦¼à¦¾à¦°, PUBG, à¦¨à¦¾à¦•à¦¿ à¦…à¦¨à§à¦¯ à¦•à¦¿à¦›à§?",
                "ðŸ“¦ à¦¬à¦¾à¦²à§à¦• à¦…à¦°à§à¦¡à¦¾à¦°? à§«à§¦à§¦à§¦+ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡à§‡ à¦¬à¦¿à¦¶à§‡à¦· à¦›à¦¾à¦¡à¦¼!",
                "ðŸŒŸ VIP à¦ªà§à¦¯à¦¾à¦•à§‡à¦œ à¦¦à§‡à¦–à¦¤à§‡ à¦šà¦¾à¦¨? à¦†à¦°à§‹ à¦¬à§‡à¦¶à¦¿ à¦¸à§à¦¬à¦¿à¦§à¦¾ à¦ªà¦¾à¦¬à§‡à¦¨!",
            ],
            
            # Order Status (80 templates)
            "order_status": [
                "ðŸ“¦ à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦° à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦šà§‡à¦• à¦•à¦°à¦¤à§‡ à¦…à¦°à§à¦¡à¦¾à¦° à¦†à¦‡à¦¡à¦¿ à¦¦à¦¿à¦¨à¥¤",
                "ðŸ” à¦…à¦°à§à¦¡à¦¾à¦° à¦Ÿà§à¦°à§à¦¯à¦¾à¦• à¦•à¦°à¦¤à§‡ à¦šà¦¾à¦¨? à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦° à¦¨à¦®à§à¦¬à¦° à¦¬à¦²à§à¦¨à¥¤",
                "â° à¦¸à¦¾à¦§à¦¾à¦°à¦£à¦¤ à§«-à§©à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡à¦° à¦®à¦§à§à¦¯à§‡ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦¹à¦¯à¦¼à§‡ à¦¯à¦¾à¦¯à¦¼à¥¤",
                "âœ… à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦° à¦ªà§à¦°à¦¸à§‡à¦¸à¦¿à¦‚ à¦ à¦†à¦›à§‡à¥¤ à¦¶à§€à¦˜à§à¦°à¦‡ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦¹à¦¬à§‡!",
                "ðŸš€ à¦¦à§à¦°à§à¦¤ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿à¦° à¦œà¦¨à§à¦¯ à¦†à¦®à¦°à¦¾ à¦•à¦¾à¦œ à¦•à¦°à¦›à¦¿!",
                "ðŸ“± à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦¨à¦«à¦¾à¦°à§à¦® à¦¹à¦²à§‡ SMS à¦ªà¦¾à¦¬à§‡à¦¨à¥¤",
                "ðŸ’¬ à¦…à¦°à§à¦¡à¦¾à¦° à¦¸à¦®à§à¦ªà¦°à§à¦•à§‡ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦ªà§‡à¦¤à§‡ à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦šà¦¾à¦²à§ à¦°à¦¾à¦–à§à¦¨à¥¤",
                "ðŸŽ¯ à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦° à¦†à¦®à¦¾à¦¦à§‡à¦° à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦•à¦¤à¦¾!",
                "âš¡ à¦à¦•à§à¦¸à¦ªà§à¦°à§‡à¦¸ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦šà¦¾à¦¨? à¦†à¦®à¦¾à¦¦à§‡à¦° à¦œà¦¾à¦¨à¦¾à¦¨!",
                "ðŸ“Š à¦…à¦°à§à¦¡à¦¾à¦° à¦¹à¦¿à¦¸à§à¦Ÿà§à¦°à¦¿ à¦¦à§‡à¦–à¦¤à§‡ à¦¡à§à¦¯à¦¾à¦¶à¦¬à§‹à¦°à§à¦¡à§‡ à¦¯à¦¾à¦¨à¥¤",
            ],
            
            # Payment Help (70 templates)
            "payment_help": [
                "ðŸ’³ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦®à§‡à¦¥à¦¡:\nâ€¢ bKash - à¦¸à¦¬à¦šà§‡à¦¯à¦¼à§‡ à¦œà¦¨à¦ªà§à¦°à¦¿à¦¯à¦¼\nâ€¢ Nagad - à¦¦à§à¦°à§à¦¤ à¦Ÿà§à¦°à¦¾à¦¨à¦œà§‡à¦•à¦¶à¦¨\nâ€¢ Rocket - à¦¸à¦¹à¦œ à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ\nà¦•à§‹à¦¨à¦Ÿà¦¿ à¦¦à¦¿à¦¯à¦¼à§‡ à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦•à¦°à¦¬à§‡à¦¨?",
                "ðŸ“± bKash à¦¨à¦®à§à¦¬à¦°: 01883800356 (Send Money)",
                "ðŸ’° à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦•à¦°à¦¾à¦° à¦ªà¦° à¦¸à§à¦•à§à¦°à¦¿à¦¨à¦¶à¦Ÿ à¦ªà¦¾à¦ à¦¾à¦¨à¥¤",
                "âœ… à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦•à¦¨à¦«à¦¾à¦°à§à¦® à¦¹à¦²à§‡ à¦¤à¦¾à§Žà¦•à§à¦·à¦£à¦¿à¦• à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦¶à§à¦°à§ à¦¹à¦¬à§‡à¥¤",
                "ðŸ”’ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦¸à¦¿à¦¸à§à¦Ÿà§‡à¦® à§§à§¦à§¦% à¦¨à¦¿à¦°à¦¾à¦ªà¦¦à¥¤",
                "ðŸ’³ à¦•à§‹à¦¨à§‹ à¦¹à¦¿à¦¡à§‡à¦¨ à¦šà¦¾à¦°à§à¦œ à¦¨à§‡à¦‡à¥¤ à¦¯à¦¾ à¦¦à§‡à¦–à¦›à§‡à¦¨ à¦¤à¦¾à¦‡ à¦¦à¦¿à¦¬à§‡à¦¨!",
                "ðŸ“ž à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦¸à¦®à¦¸à§à¦¯à¦¾? à¦•à¦² à¦•à¦°à§à¦¨: 01883800356",
                "ðŸŽ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿà§‡ à§«% à¦•à§à¦¯à¦¾à¦¶à¦¬à§à¦¯à¦¾à¦•!",
                "âš¡ à¦‡à¦¨à¦¸à§à¦Ÿà§à¦¯à¦¾à¦¨à§à¦Ÿ à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦­à§‡à¦°à¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨!",
                "ðŸ’Ž à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦¸à¦«à¦² à¦¹à¦²à§‡ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦…à¦Ÿà§‹-à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿!",
            ],
            
            # Delivery Info (60 templates)
            "delivery_info": [
                "ðŸšš à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦Ÿà¦¾à¦‡à¦®: à§«-à§©à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿ",
                "â° à¦ªà¦¿à¦• à¦†à¦“à¦¯à¦¼à¦¾à¦°à§‡ à¦à¦•à¦Ÿà§ à¦¬à§‡à¦¶à¦¿ à¦¸à¦®à¦¯à¦¼ à¦²à¦¾à¦—à¦¤à§‡ à¦ªà¦¾à¦°à§‡ (à§©à§¦-à§ªà§« à¦®à¦¿à¦¨à¦¿à¦Ÿ)",
                "âœ… à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à§§à§¦à§¦% à¦—à§à¦¯à¦¾à¦°à¦¾à¦¨à§à¦Ÿà¦¿à¦¡!",
                "ðŸ“¦ à¦†à¦ªà¦¨à¦¾à¦° à¦—à§‡à¦® à¦†à¦‡à¦¡à¦¿à¦¤à§‡ à¦¸à¦°à¦¾à¦¸à¦°à¦¿ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦¹à¦¬à§‡à¥¤",
                "ðŸŽ® à¦—à§‡à¦® à¦†à¦‡à¦¡à¦¿ à¦¸à¦ à¦¿à¦• à¦¦à¦¿à¦¯à¦¼à§‡à¦›à§‡à¦¨ à¦¤à§‹? à¦¡à¦¾à¦¬à¦² à¦šà§‡à¦• à¦•à¦°à§à¦¨!",
                "ðŸ’Ž à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦ªà§‡à¦²à§‡ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦œà¦¾à¦¨à¦¾à¦¬à§‡à¦¨!",
                "ðŸ”” à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦¹à¦²à§‡ à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦ªà¦¾à¦¬à§‡à¦¨à¥¤",
                "âš¡ à¦à¦•à§à¦¸à¦ªà§à¦°à§‡à¦¸ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿: à§«-à§§à§« à¦®à¦¿à¦¨à¦¿à¦Ÿ!",
                "ðŸŒŸ à¦†à¦®à¦°à¦¾ à¦¸à¦¬à¦šà§‡à¦¯à¦¼à§‡ à¦¦à§à¦°à§à¦¤ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦¦à§‡à¦‡!",
                "ðŸ“± à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦Ÿà§à¦°à§à¦¯à¦¾à¦• à¦•à¦°à¦¤à§‡ SMS à¦šà§‡à¦• à¦•à¦°à§à¦¨à¥¤",
            ],
            
            # Complaint Handling (50 templates)
            "complaint": [
                "ðŸ™ à¦¦à§à¦ƒà¦–à¦¿à¦¤! à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¶à§à¦¨à§‡ à¦–à¦¾à¦°à¦¾à¦ª à¦²à¦¾à¦—à¦²à§‹à¥¤ à¦†à¦®à¦°à¦¾ à¦à¦–à¦¨à¦‡ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ à¦•à¦°à¦›à¦¿!",
                "ðŸ˜” à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦¸à§à¦¬à¦¿à¦§à¦¾à¦° à¦œà¦¨à§à¦¯ à¦†à¦®à¦°à¦¾ à¦¦à§à¦ƒà¦–à¦¿à¦¤à¥¤ à¦•à¦¿ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡ à¦¬à¦²à§à¦¨?",
                "ðŸ› ï¸ à¦†à¦®à¦°à¦¾ à¦à¦–à¦¨à¦‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ à¦•à¦°à¦›à¦¿!",
                "ðŸ“ž à¦œà¦°à§à¦°à¦¿ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯à§‡à¦° à¦œà¦¨à§à¦¯ à¦•à¦² à¦•à¦°à§à¦¨: 01883800356",
                "ðŸ’¬ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦•à¦¤à¦¾!",
                "ðŸ”§ à¦Ÿà§‡à¦•à¦¨à¦¿à¦•à§à¦¯à¦¾à¦² à¦Ÿà¦¿à¦® à¦•à¦¾à¦œ à¦•à¦°à¦›à§‡à¥¤ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡à¦° à¦®à¦§à§à¦¯à§‡ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ à¦¹à¦¬à§‡!",
                "âœ… à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦­à¦¿à¦¯à§‹à¦— à¦°à§‡à¦œà¦¿à¦¸à§à¦Ÿà¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ à¦¶à§€à¦˜à§à¦°à¦‡ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ à¦ªà¦¾à¦¬à§‡à¦¨!",
                "ðŸŽ à¦…à¦¸à§à¦¬à¦¿à¦§à¦¾à¦° à¦œà¦¨à§à¦¯ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à§§à§¦à§¦ à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡ à¦«à§à¦°à¦¿ à¦¦à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦¬à§‡!",
                "ðŸ’ª à¦†à¦®à¦°à¦¾ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¾à¦¥à§‡ à¦†à¦›à¦¿à¥¤ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ à¦¨à¦¾ à¦¹à¦“à¦¯à¦¼à¦¾ à¦ªà¦°à§à¦¯à¦¨à§à¦¤!",
                "ðŸŒŸ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¨à§à¦¤à§à¦·à§à¦Ÿà¦¿ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦²à¦•à§à¦·à§à¦¯!",
            ],
            
            # Appreciation (40 templates)
            "appreciation": [
                "ðŸ™ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦…à¦¸à¦‚à¦–à§à¦¯ à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦! à¦†à¦®à¦¾à¦¦à§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦¥à¦¾à¦•à¦¾à¦° à¦œà¦¨à§à¦¯!",
                "ðŸ˜Š à¦†à¦ªà¦¨à¦¾à¦° à¦®à¦¤à§‹ à¦—à§à¦°à¦¾à¦¹à¦• à¦ªà§‡à¦¯à¦¼à§‡ à¦†à¦®à¦°à¦¾ à¦—à¦°à§à¦¬à¦¿à¦¤!",
                "â­ à¦†à¦ªà¦¨à¦¾à¦° à¦°à¦¿à¦­à¦¿à¦‰ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦…à¦¨à§à¦ªà§à¦°à§‡à¦°à¦£à¦¾!",
                "ðŸ’– à¦†à¦ªà¦¨à¦¾à¦° à¦­à¦¾à¦²à§‹à¦¬à¦¾à¦¸à¦¾ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦¶à¦•à§à¦¤à¦¿!",
                "ðŸŽ‰ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¾à¦¥à§‡ à¦•à¦¾à¦œ à¦•à¦°à§‡ à¦†à¦®à¦°à¦¾ à¦–à§à¦¶à¦¿!",
                "ðŸŒŸ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¾à¦ªà§‹à¦°à§à¦Ÿ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦à¦—à¦¿à¦¯à¦¼à§‡ à¦¨à¦¿à¦¯à¦¼à§‡ à¦¯à¦¾à¦¯à¦¼!",
                "ðŸ™Œ à¦†à¦ªà¦¨à¦¾à¦° à¦¬à¦¿à¦¶à§à¦¬à¦¾à¦¸ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦¦à¦¾à¦¯à¦¼à¦¿à¦¤à§à¦¬!",
                "ðŸ’Ž à¦†à¦ªà¦¨à¦¿ à¦†à¦®à¦¾à¦¦à§‡à¦° VIP à¦—à§à¦°à¦¾à¦¹à¦•!",
                "ðŸŽ à¦†à¦ªà¦¨à¦¾à¦° à¦œà¦¨à§à¦¯ à¦¬à¦¿à¦¶à§‡à¦· à¦…à¦«à¦¾à¦° à¦†à¦¸à¦›à§‡ à¦¶à§€à¦˜à§à¦°à¦‡!",
                "âœ¨ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¾à¦¥à§‡ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦¯à¦¾à¦¤à§à¦°à¦¾ à¦šà¦²à§à¦•!",
            ],
            
            # Farewell (30 templates)
            "farewell": [
                "ðŸ‘‹ à¦†à¦²à§à¦²à¦¾à¦¹ à¦¹à¦¾à¦«à§‡à¦œ! à¦†à¦¬à¦¾à¦° à¦¦à§‡à¦–à¦¾ à¦¹à¦¬à§‡!",
                "ðŸ˜Š à¦­à¦¾à¦²à§‹ à¦¥à¦¾à¦•à¦¬à§‡à¦¨! à¦†à¦¬à¦¾à¦° à¦†à¦¸à¦¬à§‡à¦¨!",
                "ðŸŒŸ à¦†à¦ªà¦¨à¦¾à¦° à¦¦à¦¿à¦¨à¦Ÿà¦¿ à¦¶à§à¦­ à¦¹à§‹à¦•!",
                "ðŸ’« à¦†à¦¬à¦¾à¦° à¦•à¦¥à¦¾ à¦¹à¦¬à§‡! à¦­à¦¾à¦²à§‹ à¦¥à¦¾à¦•à§à¦¨!",
                "ðŸŽ® à¦¹à§à¦¯à¦¾à¦ªà¦¿ à¦—à§‡à¦®à¦¿à¦‚! à¦†à¦¬à¦¾à¦° à¦†à¦¸à¦¬à§‡à¦¨!",
                "ðŸ‘ à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦! à¦†à¦¬à¦¾à¦° à¦¦à§‡à¦–à¦¾ à¦¹à¦¬à§‡!",
                "ðŸ™ à¦†à¦²à§à¦²à¦¾à¦¹ à¦¹à¦¾à¦«à§‡à¦œ! à¦¸à§à¦¸à§à¦¥ à¦¥à¦¾à¦•à§à¦¨!",
                "âœ¨ à¦¬à¦¾à¦‡ à¦¬à¦¾à¦‡! à¦†à¦¬à¦¾à¦° à¦†à¦¸à¦¬à§‡à¦¨!",
                "ðŸ’– à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¾à¦¥à§‡ à¦•à¦¥à¦¾ à¦¬à¦²à§‡ à¦­à¦¾à¦²à§‹ à¦²à¦¾à¦—à¦²à§‹!",
                "ðŸŒˆ à¦†à¦¬à¦¾à¦° à¦¦à§‡à¦–à¦¾ à¦¹à¦¬à§‡! à¦­à¦¾à¦²à§‹ à¦¥à¦¾à¦•à¦¬à§‡à¦¨!",
            ],
            
            # General Chat (20 templates)
            "general_chat": [
                "ðŸ˜Š à¦¹à§à¦¯à¦¾à¦, à¦†à¦®à¦¿ à¦¶à§à¦¨à¦›à¦¿! à¦¬à¦²à§à¦¨!",
                "ðŸ‘ à¦ à¦¿à¦• à¦†à¦›à§‡! à¦†à¦° à¦•à¦¿à¦›à§?",
                "ðŸ¤” à¦†à¦šà§à¦›à¦¾, à¦¬à§à¦à¦²à¦¾à¦®!",
                "ðŸ’¬ à¦†à¦°à§‹ à¦•à¦¿à¦›à§ à¦œà¦¾à¦¨à¦¤à§‡ à¦šà¦¾à¦¨?",
                "âœ… à¦¹à§à¦¯à¦¾à¦, à¦†à¦®à¦¿ à¦à¦–à¦¾à¦¨à§‡ à¦†à¦›à¦¿!",
                "ðŸŽ¯ à¦†à¦ªà¦¨à¦¾à¦° à¦•à¦¥à¦¾ à¦¬à§à¦à¦¤à§‡ à¦ªà¦¾à¦°à¦›à¦¿!",
                "ðŸ˜„ à¦¹à¦¾à¦¹à¦¾, à¦®à¦œà¦¾à¦°!",
                "ðŸŒŸ à¦¦à¦¾à¦°à§à¦£!",
                "ðŸ‘Œ à¦ªà¦¾à¦°à¦«à§‡à¦•à§à¦Ÿ!",
                "ðŸ’¯ à¦à¦•à¦¦à¦® à¦ à¦¿à¦•!",
            ],
        }
    
    def detect_intent(self, message: str) -> str:
        """Detect user intent using keyword matching and context"""
        message_lower = message.lower()
        
        # Greeting patterns
        greeting_keywords = ['hi', 'hello', 'à¦¹à¦¾à¦‡', 'à¦¹à§à¦¯à¦¾à¦²à§‹', 'à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®', 'à¦¨à¦®à¦¸à§à¦•à¦¾à¦°', 'à¦†à¦¸à¦¸à¦¾à¦²à¦¾à¦®à§', 'good morning', 'good evening']
        if any(kw in message_lower for kw in greeting_keywords):
            return "greeting"
        
        # Product inquiry patterns
        product_keywords = ['diamond', 'à¦¡à¦¾à¦¯à¦¼à¦®à¦¨à§à¦¡', 'price', 'à¦¦à¦¾à¦®', 'package', 'à¦ªà§à¦¯à¦¾à¦•à§‡à¦œ', 'à¦•à¦¿à¦¨à¦¤à§‡', 'buy', 'à¦•à¦¤', 'offer', 'à¦…à¦«à¦¾à¦°']
        if any(kw in message_lower for kw in product_keywords):
            return "product_inquiry"
        
        # Order status patterns
        order_keywords = ['order', 'à¦…à¦°à§à¦¡à¦¾à¦°', 'delivery', 'à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿', 'status', 'à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸', 'à¦•à¦¬à§‡', 'when', 'à¦ªà¦¾à¦¬à§‹']
        if any(kw in message_lower for kw in order_keywords):
            return "order_status"
        
        # Payment patterns
        payment_keywords = ['payment', 'à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ', 'bkash', 'à¦¬à¦¿à¦•à¦¾à¦¶', 'nagad', 'à¦¨à¦—à¦¦', 'rocket', 'à¦°à¦•à§‡à¦Ÿ', 'pay', 'à¦Ÿà¦¾à¦•à¦¾']
        if any(kw in message_lower for kw in payment_keywords):
            return "payment_help"
        
        # Delivery patterns
        delivery_keywords = ['delivery', 'à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿', 'time', 'à¦¸à¦®à¦¯à¦¼', 'à¦•à¦¤à¦•à§à¦·à¦£', 'how long', 'à¦ªà§Œà¦à¦›à¦¾à¦¬à§‡']
        if any(kw in message_lower for kw in delivery_keywords):
            return "delivery_info"
        
        # Complaint patterns
        complaint_keywords = ['problem', 'à¦¸à¦®à¦¸à§à¦¯à¦¾', 'issue', 'à¦¨à¦¾', 'not', 'wrong', 'à¦­à§à¦²', 'complaint', 'à¦…à¦­à¦¿à¦¯à§‹à¦—']
        if any(kw in message_lower for kw in complaint_keywords):
            return "complaint"
        
        # Appreciation patterns
        appreciation_keywords = ['thanks', 'à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦', 'thank you', 'good', 'à¦­à¦¾à¦²à§‹', 'excellent', 'à¦…à¦¸à¦¾à¦§à¦¾à¦°à¦£', 'great']
        if any(kw in message_lower for kw in appreciation_keywords):
            return "appreciation"
        
        # Farewell patterns
        farewell_keywords = ['bye', 'à¦¬à¦¾à¦‡', 'goodbye', 'à¦†à¦²à§à¦²à¦¾à¦¹ à¦¹à¦¾à¦«à§‡à¦œ', 'see you', 'à¦¦à§‡à¦–à¦¾ à¦¹à¦¬à§‡']
        if any(kw in message_lower for kw in farewell_keywords):
            return "farewell"
        
        return "general_chat"
    
    def get_response(self, user_message: str, context: Dict = None) -> str:
        """Get AI response using RL-based selection"""
        # Detect intent
        intent = self.detect_intent(user_message)
        
        # Update conversation state
        self.conversation_state = intent
        
        # Get possible responses
        possible_responses = self.templates.get(intent, self.templates["general_chat"])
        
        # Use RL to select best response
        response = self._select_response_with_rl(intent, possible_responses, context)
        
        # Add to context memory
        self.context_memory.append({
            "user_message": user_message,
            "bot_response": response,
            "intent": intent,
            "timestamp": datetime.now().isoformat()
        })
        
        # Keep only last 10 messages in memory
        if len(self.context_memory) > 10:
            self.context_memory = self.context_memory[-10:]
        
        return response
    
    def _select_response_with_rl(self, state: str, responses: List[str], context: Dict = None) -> str:
        """Select response using reinforcement learning"""
        # Exploration vs Exploitation
        if random.random() < self.exploration_rate:
            # Explore: random response
            return random.choice(responses)
        else:
            # Exploit: best known response
            state_key = f"{state}_{len(self.context_memory)}"
            
            if state_key in self.q_table:
                # Get response with highest Q-value
                best_response_idx = max(self.q_table[state_key], key=self.q_table[state_key].get)
                if best_response_idx < len(responses):
                    return responses[best_response_idx]
            
            # Default: random response
            return random.choice(responses)
    
    def update_reward(self, reward: float):
        """Update Q-table based on user feedback"""
        if len(self.context_memory) < 1:
            return
        
        last_interaction = self.context_memory[-1]
        state = last_interaction["intent"]
        state_key = f"{state}_{len(self.context_memory)-1}"
        
        # Initialize Q-table for this state if not exists
        if state_key not in self.q_table:
            self.q_table[state_key] = {}
        
        # Get response index (simplified)
        response_idx = hash(last_interaction["bot_response"]) % 100
        
        # Q-learning update
        old_q = self.q_table[state_key].get(response_idx, 0)
        new_q = old_q + self.learning_rate * (reward - old_q)
        self.q_table[state_key][response_idx] = new_q
    
    def get_context_aware_response(self, user_message: str, previous_messages: List[str] = None) -> str:
        """Get context-aware response considering conversation history"""
        # Build context
        context = {
            "previous_messages": previous_messages or [],
            "conversation_length": len(self.context_memory),
            "current_state": self.conversation_state
        }
        
        return self.get_response(user_message, context)

# Global chatbot instance
chatbot_brain = ChatbotBrain()
